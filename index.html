<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="logo.png">
  <title>HomeMiner Web Flasher</title>
  <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

    :root {
      --primary: #ffcc00;
      --dark: #0d1117;
      --light: #161b22;
      --text: #c9d1d9;
    }

    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 80px;
    }

    .logo {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
    }

    .logo img {
      height: 90px;
      filter: drop-shadow(0 0 12px rgba(255,204,0,0.6));
      transition: transform 0.3s;
    }

    .logo img:hover { transform: scale(1.08); }

    .container {
      background: var(--light);
      border-radius: 16px;
      padding: 40px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      text-align: center;
    }

    h1 { color: var(--primary); font-size: 2.4rem; margin: 0 0 10px; text-shadow: 0 0 10px rgba(255,204,0,0.5); }
    .subtitle { color: #8b949e; margin-bottom: 30px; }

    .device-select { margin: 30px 0; text-align: left; }
    label { display: block; margin-bottom: 10px; font-weight: 500; color: #8b949e; }
    select { width: 100%; padding: 12px; border-radius: 8px; background: #21262d; color: #fff; border: 1px solid #30363d; font-size: 1rem; }

    .buttons { display: flex; gap: 12px; margin: 30px 0; flex-direction: column; }
    button { padding: 14px 24px; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    #flashBtn { background: var(--primary); color: #000; }
    #flashBtn:hover { background: #ffdd33; }
    #flashBtn:disabled { background: #444; cursor: not-allowed; }


    /* New "Visit HomeMiner" button */
    #visitBtn {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      font-weight: 600;
      margin-top: 20px;
    }
    #visitBtn:hover {
      background: var(--primary);
      color: #000;
    }
    .status { margin-top: 20px; min-height: 60px; font-size: 1.1rem; }
    progress { width: 100%; height: 12px; margin: 15px 0; border-radius: 6px; background: #21262d; }
    progress::-webkit-progress-bar { background: #21262d; border-radius: 6px; }
    progress::-webkit-progress-value { background: var(--primary); border-radius: 6px; }

    .tip {
      margin-top: 30px;
      font-size: 0.9rem;
      color: #8b949e;
      background: rgba(255,204,0,0.1);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--primary);
    }
  </style>
</head>
<body>
  <!-- Logo fixed top-left -->
  <div class="logo">
    <img src="logo.png" alt="HomeMiner Logo">
  </div>

  <div class="container">
    <h1>HomeMiner Flasher</h1>
    <p class="subtitle">Flash your custom firmware to CYD or T3-Display</p>

    <div class="device-select">
      <label for="device">Select Device</label>
      <select id="device">
        <option value="cyd">Home Miner CYD (ESP32-2432S028R)</option>
        <option value="tdisplay">Home Miner T3 (T-Display S3)</option>
      </select>
    </div>

    <div class="buttons">
      <esp-web-install-button id="installButton" manifest="firmware/manifest.json" >
        <button slot="activate">Flash Firmware</button>
        <span slot="unsupported">Your browser doesn't support Web Serial (use Chrome/Edge desktop).</span>
        <div slot="progress-container">
          <progress max="100" value="0"></progress>
          <p>Flashing... <span id="progress-text">0%</span></p>
        </div>
      </esp-web-install-button>
    </div>

    <div class="status" id="status">Select device and click Flash</div>

    <div class="tip">
      <strong>Tip:</strong> Hold the BOOT button while plugging in USB if the board doesnâ€™t enter flash mode.
    </div>
  </div>
  <button id="visitBtn" onclick="window.open('https://homeminer.co.uk', '_blank')">
      Visit HomeMiner.co.uk
  </button>
  <script>
    const deviceSelect = document.getElementById('device');
    const installButton = document.getElementById('installButton');
    const statusEl = document.getElementById('status');
    const progressText = document.getElementById('progress-text');

    const manifests = {
      cyd: 'firmware/manifest.json',
      tdisplay: 'firmware/tdisplay/manifest.json'
    };

    // Change manifest when user selects different device
    deviceSelect.addEventListener('change', () => {
      const selected = deviceSelect.value;
      installButton.setAttribute('manifest', manifests[selected]);
      statusEl.textContent = `Ready to flash ${deviceSelect.options[deviceSelect.selectedIndex].text}`;
    });

    // Progress hook (same as your working code)
    document.addEventListener('esp-web-install-progress', (e) => {
      progressText.textContent = `${Math.round(e.detail.progress)}%`;
      statusEl.textContent = `Flashing... ${Math.round(e.detail.progress)}%`;
    });

    document.addEventListener('esp-web-install-success', () => {
      statusEl.textContent = 'Flash complete! Device will reboot.';
      progressText.textContent = '100%';
    });

    document.addEventListener('esp-web-install-error', (e) => {
      statusEl.textContent = 'Flash failed: ' + (e.detail.message || 'Unknown error');
      progressText.textContent = '0%';
    });
  </script>
</body>
</html>